<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>promise | myblog</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="技术博客">
    <link rel="preload" href="/vuepressblog/assets/css/0.styles.e07c7e16.css" as="style"><link rel="preload" href="/vuepressblog/assets/js/app.021642e2.js" as="script"><link rel="preload" href="/vuepressblog/assets/js/2.98b326bc.js" as="script"><link rel="preload" href="/vuepressblog/assets/js/15.f9c957ec.js" as="script"><link rel="prefetch" href="/vuepressblog/assets/js/10.e800d49d.js"><link rel="prefetch" href="/vuepressblog/assets/js/11.69e8582a.js"><link rel="prefetch" href="/vuepressblog/assets/js/12.856711db.js"><link rel="prefetch" href="/vuepressblog/assets/js/13.e7cc01ac.js"><link rel="prefetch" href="/vuepressblog/assets/js/14.b2d45490.js"><link rel="prefetch" href="/vuepressblog/assets/js/16.f5d80386.js"><link rel="prefetch" href="/vuepressblog/assets/js/17.1c1e2527.js"><link rel="prefetch" href="/vuepressblog/assets/js/18.1cb2692d.js"><link rel="prefetch" href="/vuepressblog/assets/js/19.9243d857.js"><link rel="prefetch" href="/vuepressblog/assets/js/3.efe1fa85.js"><link rel="prefetch" href="/vuepressblog/assets/js/4.90e6410b.js"><link rel="prefetch" href="/vuepressblog/assets/js/5.a178c381.js"><link rel="prefetch" href="/vuepressblog/assets/js/6.262d752d.js"><link rel="prefetch" href="/vuepressblog/assets/js/7.4de95d1b.js"><link rel="prefetch" href="/vuepressblog/assets/js/8.9282f287.js"><link rel="prefetch" href="/vuepressblog/assets/js/9.8bdb9a19.js">
    <link rel="stylesheet" href="/vuepressblog/assets/css/0.styles.e07c7e16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepressblog/" class="home-link router-link-active"><!----> <span class="site-name">myblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepressblog/blog/.html#1" class="nav-link">
  待定
</a></div><div class="nav-item"><a href="/vuepressblog/blog/.html#2" class="nav-link">
  aboutme
</a></div><div class="nav-item"><a href="/vuepressblog/blog/.html#3" class="nav-link">
  github
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepressblog/blog/.html#1" class="nav-link">
  待定
</a></div><div class="nav-item"><a href="/vuepressblog/blog/.html#2" class="nav-link">
  aboutme
</a></div><div class="nav-item"><a href="/vuepressblog/blog/.html#3" class="nav-link">
  github
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vuepressblog/blog/" aria-current="page" class="sidebar-link">home</a></li><li><a href="/vuepressblog/blog/elementui-Form.html" class="sidebar-link">elementui</a></li><li><a href="/vuepressblog/blog/elementui-loading.html" class="sidebar-link">解析elementui 中的v-loading指令</a></li><li><a href="/vuepressblog/blog/createObj.html" class="sidebar-link">使用Object 构造函数创建对象</a></li><li><a href="/vuepressblog/blog/http常用状态码.html" class="sidebar-link">http常用状态码</a></li><li><a href="/vuepressblog/blog/js 防抖debounce与节流throttle.html" class="sidebar-link">js 防抖debounce与节流throttle</a></li><li><a href="/vuepressblog/blog/LinuxData.html" class="sidebar-link">linux</a></li><li><a href="/vuepressblog/blog/promise.html" aria-current="page" class="active sidebar-link">promise</a></li><li><a href="/vuepressblog/blog/reduce.html" class="sidebar-link">reduce</a></li><li><a href="/vuepressblog/blog/linuxNginx自启动.html" class="sidebar-link">linuxNginx自启动</a></li><li><a href="/vuepressblog/blog/reflow&amp;repaint.html" class="sidebar-link">回流与重绘</a></li><li><a href="/vuepressblog/blog/固定表头和列的表格.html" class="sidebar-link">表格固定表头和列</a></li><li><a href="/vuepressblog/blog/vue-virtual-scroll-list.html" class="sidebar-link">vue虚拟滚动（vue-virtual-scroll-list）</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise"><a href="#promise" class="header-anchor">#</a> promise</h1> <div class="language- line-numbers-mode"><pre class="language-text"><code>class Promise{
  constructor(excutor){
    this.value = '';
    this.reason = '';
    this.status = 'padding'
    this.onFulfilledCallback = []
    this.onRejectedCallback = []
    let resolve = (value)=&gt;{
      /*2.这个判断是为了status不可逆 只能从 padding转化为 成功或者失败*/
      if (this.status == 'padding') {
        this.status = 'fulfilled'
        this.value = value
        /*3.当转态改变的时候依次执行队列里面储存的then函数里面对应的回调*/
        this.onFulfilledCallback.forEach(fn=&gt;{
          fn()
        })
      }
    };
    let reject = (reason)=&gt;{
      /*2.这个判断是为了status不可逆 只能从 padding转化为 成功或者失败*/
      if (this.status == 'padding') {
        this.status = 'rejected'
        this.reason = reason
        /*3.当转态改变的时候依次执行队列里面储存的then函数里面对应的回调*/
        this.onRejectedCallback.forEach(fn=&gt;{
          fn()
        })
      }
    };
    /*1. 当发生异常是捕获异常 */
    try{
      excutor(resolve,reject)
    }catch (e){
      reject(e)
    }

  }
  then(onFulfilled,onRejected){
    //4.防止使用者不传成功或失败回调函数，所以成功失败回调都给了默认回调函数
    onFulfilled = typeof onFulfilled === &quot;function&quot; ? onFulfilled : value =&gt; value;
    onRejected = typeof onRejected === &quot;function&quot; ? onRejected : error =&gt; { throw error };
    let newPromise;
    if(this.status == 'fulfilled'){
      return newPromise = new Promise((resolve,reject)=&gt;{
        setTimeout(()=&gt;{
          try{
            let x = onFulfilled(this.value)
            this.resolvePromise(newPromise, x, resolve, reject);
          }catch (e){
            reject(e)
          }
        })

      })

    }
    if(this.status == 'rejected'){
      return newPromise = new Promise((resolve,reject)=&gt;{
        setTimeout(()=&gt;{
          try{
            let x = onRejected(this.reason)
            this.resolvePromise(newPromise, x, resolve, reject);
          }catch (e){
            reject(e)
          }
        })

      })

    }
    if(this.status == 'padding'){
      return newPromise = new Promise((resolve,reject)=&gt; {
        /*3.当excutor为异步的时候先把then方法里面的回调储存在失败或者成功的队列里面*/
        this.onFulfilledCallback.push(() =&gt; {
          //这里可以写其他的代码对resolve做一层封装todo
          setTimeout(()=&gt; {
            try {
              let x = onFulfilled(this.value)
              this.resolvePromise(newPromise, x, resolve, reject);
            } catch (e) {
              reject(e)
            }
          })
        })
        this.onRejectedCallback.push(() =&gt; {
          setTimeout(()=&gt; {
            try {
              let x = onRejected(this.reason)
              this.resolvePromise(newPromise, x, resolve, reject);
            } catch (e) {
              reject(e)
            }
          })
        })
      })
    }
    //4.保证链式调用 返回this  这样做虽然能链式调用但是 所有链式调用的回调函数都挂载到同一个对象上 且当后面的then方法执行
    //的时候promise的状态已经确定会马上执行其对应的回调，并且参数都为this.value这一个值
    //return this
  }
  catch(onRejected){
    this.then(null,onRejected)
  }
  resolvePromise(newPromise,x,resolve,reject){
    //2.3.1规范，避免循环引用
    if (newPromise === x) {
      return reject(new TypeError('Circular reference'));
    }
    //called变量主要是用来判断如果resolvePromise函数已经resolve或者reject了，那就不需要在执行下面的resolce或者reject。
    //设置一个标志位，在执行resolve或者reject其中之一后，讲不能再执行resolve或者reject  eg:resolve();reject()
    let called = false;
    if (x != null &amp;&amp; ((typeof x === 'object') || (typeof x === 'function'))) {
      try{
        let then = x.then;
        if (typeof then === 'function') {
          //2.3.3.3 如果 then 是一个函数，以x为this调用then函数，且第一个参数是resolve，第二个参数是reject
          then.call(x, y =&gt; {
            if (called) return;
            called = true;
            this.resolvePromise(newPromise, y, resolve, reject);
          }, error =&gt; {
            if (called) return;
            called = true;
            reject(error);
          })
        } else {
          //2.3.3.4 如果 then不是一个函数，则 以x为值fulfill promise。
          resolve(x);
        }
      }catch(e){
        if (called) return;
        called = true;
        reject(e);
      }

    }else {
      resolve(x)
    }
  }

}
// 执行测试用例需要用到的代码
Promise.deferred = function() {
  let defer = {};
  defer.promise = new Promise((resolve, reject) =&gt; {
    defer.resolve = resolve;
    defer.reject = reject;
  });
  return defer;
}
try {
  module.exports = Promise
} catch (e) {}

// 1.npm i -g promises-aplus-tests
// 2.promises-aplus-tests mypromise.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepressblog/blog/LinuxData.html" class="prev">
        linux
      </a></span> <span class="next"><a href="/vuepressblog/blog/reduce.html">
        reduce
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vuepressblog/assets/js/app.021642e2.js" defer></script><script src="/vuepressblog/assets/js/2.98b326bc.js" defer></script><script src="/vuepressblog/assets/js/15.f9c957ec.js" defer></script>
  </body>
</html>
